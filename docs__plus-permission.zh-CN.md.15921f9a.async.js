"use strict";(self.webpackChunkmetis_ui=self.webpackChunkmetis_ui||[]).push([[1695],{13574:function(i,_,s){s.r(_);var u=s(37496),c=s(82857),l=s(91238),m=s(83120),x=s(48415),h=s(95300),p=s(11024),I=s(65110),v=s(10006),j=s(18637),E=s(741),f=s(30166),t=s(91512),a=s(35055),r=s(30158),d=s(39546),n=s(61371),e=s(74132);function o(){return(0,e.jsx)(a.DumiPage,{children:(0,e.jsx)(d.Suspense,{fallback:(0,e.jsx)(r.Z,{}),children:(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)("div",{className:"markdown",children:[(0,e.jsx)("p",{children:n.texts[0].value}),(0,e.jsxs)("h2",{id:"\u7CFB\u7EDF\u67B6\u6784",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u7CFB\u7EDF\u67B6\u6784",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"\u7CFB\u7EDF\u67B6\u6784"]}),(0,e.jsxs)("p",{children:[n.texts[1].value,(0,e.jsx)("strong",{children:n.texts[2].value}),n.texts[3].value]}),(0,e.jsxs)("ul",{children:[(0,e.jsxs)("li",{children:[(0,e.jsx)("strong",{children:n.texts[4].value}),n.texts[5].value]}),(0,e.jsxs)("li",{children:[(0,e.jsx)("strong",{children:n.texts[6].value}),n.texts[7].value]}),(0,e.jsxs)("li",{children:[(0,e.jsx)("strong",{children:n.texts[8].value}),n.texts[9].value]}),(0,e.jsxs)("li",{children:[(0,e.jsx)("strong",{children:n.texts[10].value}),n.texts[11].value]})]}),(0,e.jsxs)("h2",{id:"\u6743\u9650\u6570\u636E\u7ED3\u6784",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u6743\u9650\u6570\u636E\u7ED3\u6784",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"\u6743\u9650\u6570\u636E\u7ED3\u6784"]}),(0,e.jsxs)("h3",{id:"\u7528\u6237\u6743\u9650\u683C\u5F0F",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u7528\u6237\u6743\u9650\u683C\u5F0F",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"\u7528\u6237\u6743\u9650\u683C\u5F0F"]}),(0,e.jsx)(t.Z,{lang:"typescript",children:n.texts[12].value}),(0,e.jsxs)("h3",{id:"\u6743\u9650\u68C0\u67E5\u683C\u5F0F",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u6743\u9650\u68C0\u67E5\u683C\u5F0F",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"\u6743\u9650\u68C0\u67E5\u683C\u5F0F"]}),(0,e.jsx)(t.Z,{lang:"typescript",children:n.texts[13].value}),(0,e.jsxs)("h2",{id:"\u6743\u9650\u914D\u7F6E",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u6743\u9650\u914D\u7F6E",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"\u6743\u9650\u914D\u7F6E"]}),(0,e.jsxs)("h3",{id:"1-\u7528\u6237\u6743\u9650\u914D\u7F6E",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#1-\u7528\u6237\u6743\u9650\u914D\u7F6E",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"1. \u7528\u6237\u6743\u9650\u914D\u7F6E"]}),(0,e.jsx)("p",{children:n.texts[14].value}),(0,e.jsxs)("p",{children:[n.texts[15].value,(0,e.jsx)("code",{children:n.texts[16].value}),n.texts[17].value]}),(0,e.jsx)(t.Z,{title:"src/mocks/handlers/user.ts",lang:"ts",children:n.texts[18].value}),(0,e.jsxs)("h3",{id:"2-\u8DEF\u7531\u6743\u9650\u914D\u7F6E",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#2-\u8DEF\u7531\u6743\u9650\u914D\u7F6E",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"2. \u8DEF\u7531\u6743\u9650\u914D\u7F6E"]}),(0,e.jsxs)("p",{children:[n.texts[19].value,(0,e.jsx)("code",{children:n.texts[20].value}),n.texts[21].value]}),(0,e.jsx)(t.Z,{title:"src/routes.tsx",lang:"tsx",children:n.texts[22].value}),(0,e.jsxs)("h2",{id:"\u6743\u9650\u7EC4\u4EF6",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u6743\u9650\u7EC4\u4EF6",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"\u6743\u9650\u7EC4\u4EF6"]}),(0,e.jsxs)("h3",{id:"access-\u6743\u9650\u63A7\u5236\u7EC4\u4EF6",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#access-\u6743\u9650\u63A7\u5236\u7EC4\u4EF6",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"Access \u6743\u9650\u63A7\u5236\u7EC4\u4EF6"]}),(0,e.jsx)("p",{children:n.texts[23].value}),(0,e.jsx)(t.Z,{lang:"tsx",children:n.texts[24].value}),(0,e.jsxs)("h2",{id:"\u83DC\u5355\u6743\u9650\u8FC7\u6EE4",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u83DC\u5355\u6743\u9650\u8FC7\u6EE4",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"\u83DC\u5355\u6743\u9650\u8FC7\u6EE4"]}),(0,e.jsxs)("p",{children:[n.texts[25].value,(0,e.jsx)("code",{children:n.texts[26].value}),n.texts[27].value]}),(0,e.jsx)(t.Z,{title:"src/utils/menu.ts",lang:"ts",children:n.texts[28].value}),(0,e.jsxs)("h2",{id:"\u8DEF\u7531\u5B88\u536B",children:[(0,e.jsx)("a",{"aria-hidden":"true",tabIndex:"-1",href:"#\u8DEF\u7531\u5B88\u536B",children:(0,e.jsx)("span",{className:"icon icon-link"})}),"\u8DEF\u7531\u5B88\u536B"]}),(0,e.jsxs)("p",{children:[n.texts[29].value,(0,e.jsx)("code",{children:n.texts[30].value}),n.texts[31].value,(0,e.jsx)("code",{children:n.texts[32].value}),n.texts[33].value]}),(0,e.jsx)(t.Z,{lang:"typescript",children:n.texts[34].value}),(0,e.jsx)("p",{children:n.texts[35].value})]})})})})}_.default=o},61371:function(i,_,s){s.r(_),s.d(_,{texts:function(){return u}});const u=[{value:"\u6743\u9650\u63A7\u5236\u662F\u4E2D\u540E\u53F0\u573A\u666F\u975E\u5E38\u5E38\u89C1\u7684\u57FA\u7840\u529F\u80FD\uFF0CMetis Plus \u63D0\u4F9B\u4E86\u5B8C\u6574\u7684\u6743\u9650\u7BA1\u7406\u89E3\u51B3\u65B9\u6848\uFF0C\u5305\u62EC\u7528\u6237\u8BA4\u8BC1\u3001\u6743\u9650\u6821\u9A8C\u3001\u83DC\u5355\u8FC7\u6EE4\u3001\u8DEF\u7531\u5B88\u536B\u7B49\u529F\u80FD\u3002",paraId:0},{value:"Metis Plus \u7684\u6743\u9650\u7CFB\u7EDF\u57FA\u4E8E ",paraId:1,tocIndex:0},{value:"RBAC\uFF08\u57FA\u4E8E\u89D2\u8272\u7684\u8BBF\u95EE\u63A7\u5236\uFF09",paraId:1,tocIndex:0},{value:" \u6A21\u578B\u8BBE\u8BA1\uFF0C\u4E3B\u8981\u5305\u542B\u4EE5\u4E0B\u51E0\u4E2A\u6838\u5FC3\u6982\u5FF5\uFF1A",paraId:1,tocIndex:0},{value:"\u7528\u6237\uFF08User\uFF09",paraId:2,tocIndex:0},{value:"\uFF1A\u7CFB\u7EDF\u7684\u4F7F\u7528\u8005",paraId:2,tocIndex:0},{value:"\u6743\u9650\uFF08Permission\uFF09",paraId:2,tocIndex:0},{value:"\uFF1A\u5177\u4F53\u7684\u64CD\u4F5C\u6743\u9650\uFF0C\u7531\u8D44\u6E90\u548C\u52A8\u4F5C\u7EC4\u6210",paraId:2,tocIndex:0},{value:"\u8D44\u6E90\uFF08Resource\uFF09",paraId:2,tocIndex:0},{value:"\uFF1A\u7CFB\u7EDF\u4E2D\u7684\u529F\u80FD\u6A21\u5757\u6216\u6570\u636E\u5B9E\u4F53",paraId:2,tocIndex:0},{value:"\u52A8\u4F5C\uFF08Action\uFF09",paraId:2,tocIndex:0},{value:"\uFF1A\u5BF9\u8D44\u6E90\u7684\u5177\u4F53\u64CD\u4F5C\uFF0C\u5982\u8BFB\u53D6\u3001\u7F16\u8F91\u3001\u5220\u9664\u7B49",paraId:2,tocIndex:0},{value:`export type UserPermissions = {
  resource: string; // \u8D44\u6E90\u540D\u79F0
  actions?: string[]; // \u5141\u8BB8\u7684\u64CD\u4F5C\u5217\u8868
}[];

// \u793A\u4F8B
const userPermissions: UserPermissions = [
  { resource: 'dashboard', actions: ['view'] },
  { resource: 'admin', actions: ['read', 'edit', 'delete'] },
  { resource: 'workplace' }, // \u65E0 actions \u8868\u793A\u62E5\u6709\u8BE5\u8D44\u6E90\u7684\u6240\u6709\u6743\u9650
];
`,paraId:3,tocIndex:2},{value:`export type Permission =
  | Auth // \u5355\u4E2A\u6743\u9650
  | Permission[] // \u6743\u9650\u6570\u7EC4\uFF08\u4E14\u5173\u7CFB\uFF09
  | { and: Permission[] } // \u660E\u786E\u7684\u4E14\u5173\u7CFB
  | { or: Permission[] }; // \u6216\u5173\u7CFB

export type Auth = { resource: Resource; actions?: string[] } | Resource; // \u53EF\u4EE5\u76F4\u63A5\u4F7F\u7528\u5B57\u7B26\u4E32\u6216\u6B63\u5219

type Resource = string | RegExp;
`,paraId:4,tocIndex:3},{value:"\u5B9E\u9645\u9879\u76EE\u4E2D\u7528\u6237\u6743\u9650\u7531\u670D\u52A1\u7AEF\u8FD4\u56DE\uFF0C\u8FD9\u91CC\u6211\u4EEC\u4F7F\u7528 mock \u6570\u636E\u4EE3\u66FF\u3002",paraId:5,tocIndex:5},{value:"\u5728 ",paraId:6,tocIndex:5},{value:"src/mocks/handlers/user.ts",paraId:6,tocIndex:5},{value:" \u4E2D\u914D\u7F6E\u4E0D\u540C\u7528\u6237\u7684\u6743\u9650\uFF1A",paraId:6,tocIndex:5},{value:`http.get('/api/currentUser', async ({ request }) => {
  const token = request.headers.get('authorization') || '';

  let permissions: UserPermissions = [];
  if (token === 'fake_token_admin') {
    permissions = [
      { resource: 'admin', actions: ['read', 'edit', 'delete'] },
      { resource: 'dashboard', actions: ['view'] },
      { resource: 'workplace' },
    ];
  } else if (token === 'fake_token_user') {
    permissions = [{ resource: 'dashboard', actions: ['view'] }, { resource: 'workplace' }];
  }

  return HttpResponse.json({
    success: true,
    data: { permissions /* \u5176\u4ED6\u7528\u6237\u4FE1\u606F */ },
  });
});
`,paraId:7,tocIndex:5},{value:"\u5728 ",paraId:8,tocIndex:6},{value:"src/routes.tsx",paraId:8,tocIndex:6},{value:" \u4E2D\u4E3A\u8DEF\u7531\u914D\u7F6E\u6743\u9650\uFF1A",paraId:8,tocIndex:6},{value:`const routes: Route[] = [
  {
    name: 'menu.workplace',
    icon: <Squares2X2Outline />,
    path: 'workplace',
    component: () => import('@/pages/workplace'),
  },
  {
    name: 'menu.admin',
    icon: <Cog6ToothOutline />,
    path: 'admin',
    component: () => import('@/pages/admin'),
    permission: { resource: 'admin', actions: ['read'] }, // \u9700\u8981\u7BA1\u7406\u5458\u8BFB\u53D6\u6743\u9650
  },
];
`,paraId:9,tocIndex:6},{value:"\u7528\u4E8E\u5728\u7EC4\u4EF6\u4E2D\u8FDB\u884C\u6743\u9650\u63A7\u5236\uFF1A",paraId:10,tocIndex:8},{value:`import Access from '@/components/Access';

const MyComponent = () => {
  return (
    <div>
      {/* \u57FA\u672C\u4F7F\u7528 */}
      <Access permission={{ resource: 'admin' }}>
        <Button>\u7BA1\u7406\u5458\u4E13\u7528\u6309\u94AE</Button>
      </Access>

      {/* \u5E26 fallback */}
      <Access
        permission={{ resource: 'admin', actions: ['edit'] }}
        fallback={<span>\u6743\u9650\u4E0D\u8DB3</span>}
      >
        <Button>\u7F16\u8F91</Button>
      </Access>

      {/* \u590D\u6742\u6743\u9650 */}
      <Access
        permission={{
          or: [{ resource: 'admin' }, { resource: 'editor', actions: ['publish'] }],
        }}
      >
        <Button>\u53D1\u5E03\u6587\u7AE0</Button>
      </Access>
    </div>
  );
};
`,paraId:11,tocIndex:8},{value:"\u83DC\u5355\u7CFB\u7EDF\u4F1A\u81EA\u52A8\u6839\u636E\u7528\u6237\u6743\u9650\u8FC7\u6EE4\u4E0D\u53EF\u8BBF\u95EE\u7684\u83DC\u5355\u9879\u3002\u6743\u9650\u8FC7\u6EE4\u903B\u8F91\u5728 ",paraId:12,tocIndex:9},{value:"src/utils/menu.ts",paraId:12,tocIndex:9},{value:" \u4E2D\u5B9E\u73B0\uFF1A",paraId:12,tocIndex:9},{value:`export function formatter(
  { data, t, userPerms }: FormatterProps,
  parentPath = '/',
  ignoreFilter = false,
): MenuDataItem[] {
  return data
    .filter((item) => {
      // \u9690\u85CF\u83DC\u5355\u8FC7\u6EE4
      if (!ignoreFilter && item.hideInMenu) return false;
      // \u6743\u9650\u8FC7\u6EE4
      if (item.permission && !hasPermission(item.permission, userPerms)) return false;
      return true;
    })
    .flatMap((item) => {
      // \u83DC\u5355\u9879\u5904\u7406\u903B\u8F91
    });
}
`,paraId:13,tocIndex:9},{value:"\u8DEF\u7531\u7EA7\u522B\u7684\u6743\u9650\u63A7\u5236\u901A\u8FC7 ",paraId:14,tocIndex:10},{value:"Access",paraId:14,tocIndex:10},{value:" \u7EC4\u4EF6\u5B9E\u73B0\uFF0C\u5728 ",paraId:14,tocIndex:10},{value:"src/routes.tsx",paraId:14,tocIndex:10},{value:" \u4E2D\u81EA\u52A8\u5305\u88C5\uFF1A",paraId:14,tocIndex:10},{value:`// src/routes.tsx
function generateRouteObjects(routes: Route[]): RouteObject[] {
  return routes.map((route) => {
    const { component, children, permission, ...rest } = route;

    const routeObj: RouteObject = { ...rest };

    if (component) {
      const Component = lazy(component);
      routeObj.element = (
        <Suspense fallback={<Loading />}>
          <Component />
        </Suspense>
      );

      // \u81EA\u52A8\u6DFB\u52A0\u6743\u9650\u5B88\u536B
      if (permission) {
        routeObj.element = (
          <Access permission={permission} fallback={<Err403 />}>
            {routeObj.element}
          </Access>
        );
      }
    }

    if (Array.isArray(children) && children.length > 0) {
      routeObj.children = generateRouteObjects(children);
    }

    return routeObj;
  });
}
`,paraId:15,tocIndex:10},{value:"\u901A\u8FC7\u4EE5\u4E0A\u6743\u9650\u63A7\u5236\u7CFB\u7EDF\uFF0CMetis Plus \u4E3A\u4E2D\u540E\u53F0\u5E94\u7528\u63D0\u4F9B\u4E86\u5B8C\u6574\u3001\u7075\u6D3B\u3001\u6613\u7528\u7684\u6743\u9650\u7BA1\u7406\u89E3\u51B3\u65B9\u6848\uFF0C\u5E2E\u52A9\u5F00\u53D1\u8005\u5FEB\u901F\u6784\u5EFA\u5B89\u5168\u53EF\u9760\u7684\u4F01\u4E1A\u7EA7\u5E94\u7528\u3002",paraId:16,tocIndex:10}]}}]);
